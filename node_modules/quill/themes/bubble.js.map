{"version":3,"file":"bubble.js","names":["_lodashEs","require","_emitter","_interopRequireDefault","_base","_interopRequireWildcard","_selection","_icons","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","TOOLBAR_CONFIG","header","BubbleTooltip","BaseTooltip","TEMPLATE","join","constructor","quill","bounds","on","Emitter","events","EDITOR_CHANGE","type","range","oldRange","source","SELECTION_CHANGE","length","sources","USER","show","root","style","left","width","offsetWidth","lines","getLines","index","getBounds","position","lastLine","getIndex","Math","min","indexBounds","Range","document","activeElement","textbox","hasFocus","hide","listen","querySelector","addEventListener","classList","remove","SCROLL_OPTIMIZE","setTimeout","contains","getSelection","cancel","reference","shift","arrow","marginLeft","exports","BubbleTheme","BaseTheme","options","modules","toolbar","container","add","extendToolbar","tooltip","appendChild","buildButtons","querySelectorAll","icons","buildPickers","DEFAULTS","merge","handlers","link","value","format","theme","edit"],"sources":["../../src/themes/bubble.ts"],"sourcesContent":["import { merge } from 'lodash-es';\nimport Emitter from '../core/emitter';\nimport BaseTheme, { BaseTooltip } from './base';\nimport { Range } from '../core/selection';\nimport type { Bounds } from '../core/selection';\nimport icons from '../ui/icons';\nimport type Quill from '../core';\nimport type { ThemeOptions } from '../core/theme';\nimport type Toolbar from '../modules/toolbar';\nimport type { ToolbarConfig } from '../modules/toolbar';\n\nconst TOOLBAR_CONFIG: ToolbarConfig = [\n  ['bold', 'italic', 'link'],\n  [{ header: 1 }, { header: 2 }, 'blockquote'],\n];\n\nclass BubbleTooltip extends BaseTooltip {\n  static TEMPLATE = [\n    '<span class=\"ql-tooltip-arrow\"></span>',\n    '<div class=\"ql-tooltip-editor\">',\n    '<input type=\"text\" data-formula=\"e=mc^2\" data-link=\"https://quilljs.com\" data-video=\"Embed URL\">',\n    '<a class=\"ql-close\"></a>',\n    '</div>',\n  ].join('');\n\n  constructor(quill: Quill, bounds?: HTMLElement) {\n    super(quill, bounds);\n    this.quill.on(\n      Emitter.events.EDITOR_CHANGE,\n      (type, range, oldRange, source) => {\n        if (type !== Emitter.events.SELECTION_CHANGE) return;\n        if (\n          range != null &&\n          range.length > 0 &&\n          source === Emitter.sources.USER\n        ) {\n          this.show();\n          // Lock our width so we will expand beyond our offsetParent boundaries\n          this.root.style.left = '0px';\n          this.root.style.width = '';\n          this.root.style.width = `${this.root.offsetWidth}px`;\n          const lines = this.quill.getLines(range.index, range.length);\n          if (lines.length === 1) {\n            const bounds = this.quill.getBounds(range);\n            if (bounds != null) {\n              this.position(bounds);\n            }\n          } else {\n            const lastLine = lines[lines.length - 1];\n            const index = this.quill.getIndex(lastLine);\n            const length = Math.min(\n              lastLine.length() - 1,\n              range.index + range.length - index,\n            );\n            const indexBounds = this.quill.getBounds(new Range(index, length));\n            if (indexBounds != null) {\n              this.position(indexBounds);\n            }\n          }\n        } else if (\n          document.activeElement !== this.textbox &&\n          this.quill.hasFocus()\n        ) {\n          this.hide();\n        }\n      },\n    );\n  }\n\n  listen() {\n    super.listen();\n    // @ts-expect-error Fix me later\n    this.root.querySelector('.ql-close').addEventListener('click', () => {\n      this.root.classList.remove('ql-editing');\n    });\n    this.quill.on(Emitter.events.SCROLL_OPTIMIZE, () => {\n      // Let selection be restored by toolbar handlers before repositioning\n      setTimeout(() => {\n        if (this.root.classList.contains('ql-hidden')) return;\n        const range = this.quill.getSelection();\n        if (range != null) {\n          const bounds = this.quill.getBounds(range);\n          if (bounds != null) {\n            this.position(bounds);\n          }\n        }\n      }, 1);\n    });\n  }\n\n  cancel() {\n    this.show();\n  }\n\n  position(reference: Bounds) {\n    const shift = super.position(reference);\n    const arrow = this.root.querySelector('.ql-tooltip-arrow');\n    // @ts-expect-error\n    arrow.style.marginLeft = '';\n    if (shift !== 0) {\n      // @ts-expect-error\n      arrow.style.marginLeft = `${-1 * shift - arrow.offsetWidth / 2}px`;\n    }\n    return shift;\n  }\n}\n\nclass BubbleTheme extends BaseTheme {\n  constructor(quill: Quill, options: ThemeOptions) {\n    if (\n      options.modules.toolbar != null &&\n      options.modules.toolbar.container == null\n    ) {\n      options.modules.toolbar.container = TOOLBAR_CONFIG;\n    }\n    super(quill, options);\n    this.quill.container.classList.add('ql-bubble');\n  }\n\n  extendToolbar(toolbar: Toolbar) {\n    // @ts-expect-error\n    this.tooltip = new BubbleTooltip(this.quill, this.options.bounds);\n    if (toolbar.container != null) {\n      this.tooltip.root.appendChild<HTMLElement>(toolbar.container);\n      this.buildButtons(toolbar.container.querySelectorAll('button'), icons);\n      this.buildPickers(toolbar.container.querySelectorAll('select'), icons);\n    }\n  }\n}\nBubbleTheme.DEFAULTS = merge({}, BaseTheme.DEFAULTS, {\n  modules: {\n    toolbar: {\n      handlers: {\n        link(value: string) {\n          if (!value) {\n            this.quill.format('link', false);\n          } else {\n            this.quill.theme.tooltip.edit();\n          }\n        },\n      },\n    },\n  },\n});\n\nexport { BubbleTooltip, BubbleTheme as default };\n"],"mappings":"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"}