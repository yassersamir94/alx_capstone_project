{"version":3,"file":"syntax.js","names":["_quillDelta","_interopRequireDefault","require","_parchment","_inline","_quill","_module","_block","_break","_cursor","_text","_interopRequireWildcard","_code","_clipboard","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","TokenAttributor","ClassAttributor","scope","Scope","INLINE","CodeToken","Inline","formats","node","scroll","domNode","classList","contains","CodeBlock","className","parentNode","undefined","constructor","value","add","format","blotName","remove","statics","optimize","arguments","unwrap","exports","SyntaxCodeBlock","create","setAttribute","getAttribute","register","name","replaceWith","formatAt","length","SyntaxCodeBlockContainer","CodeBlockContainer","attach","forceNext","emitMount","children","forEach","child","index","highlight","forced","head","nodes","Array","from","childNodes","filter","uiNode","text","map","textContent","join","language","cachedText","trim","oldDelta","reduce","delta","concat","blockDelta","Delta","diff","_ref","retain","attributes","keys","includes","html","codeBlock","find","escapeText","code","context","parent","allowedChildren","requiredContainer","CursorBlot","TextBlot","BreakBlot","Syntax","Module","Quill","quill","options","hljs","Error","languages","memo","_ref2","key","highlightBlot","bind","initListener","initTimer","on","events","SCROLL_BLOT_MOUNT","blot","select","root","ownerDocument","createElement","_ref3","label","option","appendChild","addEventListener","focus","attachUI","timer","SCROLL_OPTIMIZE","clearTimeout","setTimeout","interval","force","selection","composing","update","sources","USER","range","getSelection","blots","descendants","container","SILENT","setSelection","split","line","insert","innerHTML","traverse","compose","data","nodeText","DEFAULTS","window"],"sources":["../../src/modules/syntax.ts"],"sourcesContent":["import Delta from 'quill-delta';\nimport { ClassAttributor, Scope } from 'parchment';\nimport type { Blot, ScrollBlot } from 'parchment';\nimport Inline from '../blots/inline';\nimport Quill from '../core/quill';\nimport Module from '../core/module';\nimport { blockDelta } from '../blots/block';\nimport BreakBlot from '../blots/break';\nimport CursorBlot from '../blots/cursor';\nimport TextBlot, { escapeText } from '../blots/text';\nimport CodeBlock, { CodeBlockContainer } from '../formats/code';\nimport { traverse } from './clipboard';\n\nconst TokenAttributor = new ClassAttributor('code-token', 'hljs', {\n  scope: Scope.INLINE,\n});\nclass CodeToken extends Inline {\n  static formats(node: Element, scroll: ScrollBlot) {\n    while (node != null && node !== scroll.domNode) {\n      if (node.classList && node.classList.contains(CodeBlock.className)) {\n        // @ts-expect-error\n        return super.formats(node, scroll);\n      }\n      // @ts-expect-error\n      node = node.parentNode;\n    }\n    return undefined;\n  }\n\n  constructor(scroll: ScrollBlot, domNode: Node, value: unknown) {\n    // @ts-expect-error\n    super(scroll, domNode, value);\n    // @ts-expect-error\n    TokenAttributor.add(this.domNode, value);\n  }\n\n  format(format: string, value: unknown) {\n    if (format !== CodeToken.blotName) {\n      super.format(format, value);\n    } else if (value) {\n      // @ts-expect-error\n      TokenAttributor.add(this.domNode, value);\n    } else {\n      TokenAttributor.remove(this.domNode);\n      this.domNode.classList.remove(this.statics.className);\n    }\n  }\n\n  optimize(...args: unknown[]) {\n    // @ts-expect-error\n    super.optimize(...args);\n    if (!TokenAttributor.value(this.domNode)) {\n      this.unwrap();\n    }\n  }\n}\nCodeToken.blotName = 'code-token';\nCodeToken.className = 'ql-token';\n\nclass SyntaxCodeBlock extends CodeBlock {\n  static create(value: unknown) {\n    const domNode = super.create(value);\n    if (typeof value === 'string') {\n      // @ts-expect-error\n      domNode.setAttribute('data-language', value);\n    }\n    return domNode;\n  }\n\n  static formats(domNode: Node) {\n    // @ts-expect-error\n    return domNode.getAttribute('data-language') || 'plain';\n  }\n\n  static register() {} // Syntax module will register\n\n  format(name: string, value: unknown) {\n    if (name === this.statics.blotName && value) {\n      // @ts-expect-error\n      this.domNode.setAttribute('data-language', value);\n    } else {\n      super.format(name, value);\n    }\n  }\n\n  replaceWith(name: string, value: unknown) {\n    this.formatAt(0, this.length(), CodeToken.blotName, false);\n    return super.replaceWith(name, value);\n  }\n}\n\nclass SyntaxCodeBlockContainer extends CodeBlockContainer {\n  forceNext?: boolean;\n  cachedText?: string | null;\n\n  attach() {\n    super.attach();\n    this.forceNext = false;\n    // @ts-expect-error\n    this.scroll.emitMount(this);\n  }\n\n  format(name: string, value: unknown) {\n    if (name === SyntaxCodeBlock.blotName) {\n      this.forceNext = true;\n      this.children.forEach((child) => {\n        // @ts-expect-error\n        child.format(name, value);\n      });\n    }\n  }\n\n  formatAt(index: number, length: number, name: string, value: unknown) {\n    if (name === SyntaxCodeBlock.blotName) {\n      this.forceNext = true;\n    }\n    super.formatAt(index, length, name, value);\n  }\n\n  highlight(\n    highlight: (text: string, language: string) => Delta,\n    forced = false,\n  ) {\n    if (this.children.head == null) return;\n    const nodes = Array.from(this.domNode.childNodes).filter(\n      (node) => node !== this.uiNode,\n    );\n    const text = `${nodes.map((node) => node.textContent).join('\\n')}\\n`;\n    const language = SyntaxCodeBlock.formats(this.children.head.domNode);\n    if (forced || this.forceNext || this.cachedText !== text) {\n      if (text.trim().length > 0 || this.cachedText == null) {\n        const oldDelta = this.children.reduce((delta, child) => {\n          // @ts-expect-error\n          return delta.concat(blockDelta(child, false));\n        }, new Delta());\n        const delta = highlight(text, language);\n        oldDelta.diff(delta).reduce((index, { retain, attributes }) => {\n          // Should be all retains\n          if (!retain) return index;\n          if (attributes) {\n            Object.keys(attributes).forEach((format) => {\n              if (\n                [SyntaxCodeBlock.blotName, CodeToken.blotName].includes(format)\n              ) {\n                // @ts-expect-error\n                this.formatAt(index, retain, format, attributes[format]);\n              }\n            });\n          }\n          // @ts-expect-error\n          return index + retain;\n        }, 0);\n      }\n      this.cachedText = text;\n      this.forceNext = false;\n    }\n  }\n\n  html(index: number, length: number) {\n    const [codeBlock] = this.children.find(index);\n    const language = codeBlock\n      ? SyntaxCodeBlock.formats(codeBlock.domNode)\n      : 'plain';\n\n    return `<pre data-language=\"${language}\">\\n${escapeText(\n      this.code(index, length),\n    )}\\n</pre>`;\n  }\n\n  optimize(context: Record<string, any>) {\n    super.optimize(context);\n    if (\n      this.parent != null &&\n      this.children.head != null &&\n      this.uiNode != null\n    ) {\n      const language = SyntaxCodeBlock.formats(this.children.head.domNode);\n      // @ts-expect-error\n      if (language !== this.uiNode.value) {\n        // @ts-expect-error\n        this.uiNode.value = language;\n      }\n    }\n  }\n}\n// @ts-expect-error\nSyntaxCodeBlockContainer.allowedChildren = [SyntaxCodeBlock];\nSyntaxCodeBlock.requiredContainer = SyntaxCodeBlockContainer;\nSyntaxCodeBlock.allowedChildren = [CodeToken, CursorBlot, TextBlot, BreakBlot];\n\ninterface SyntaxOptions {\n  interval: number;\n  languages: { key: string; label: string }[];\n}\n\nclass Syntax extends Module<SyntaxOptions> {\n  static DEFAULTS: SyntaxOptions & { hljs: any };\n\n  static register() {\n    Quill.register(CodeToken, true);\n    // @ts-expect-error\n    Quill.register(SyntaxCodeBlock, true);\n    Quill.register(SyntaxCodeBlockContainer, true);\n  }\n\n  languages: Record<string, true>;\n\n  constructor(quill: Quill, options: Partial<SyntaxOptions>) {\n    super(quill, options);\n    // @ts-expect-error\n    if (this.options.hljs == null) {\n      throw new Error(\n        'Syntax module requires highlight.js. Please include the library on the page before Quill.',\n      );\n    }\n    // @ts-expect-error Fix me later\n    this.languages = this.options.languages.reduce(\n      (memo: Record<string, unknown>, { key }) => {\n        memo[key] = true;\n        return memo;\n      },\n      {},\n    );\n    this.highlightBlot = this.highlightBlot.bind(this);\n    this.initListener();\n    this.initTimer();\n  }\n\n  initListener() {\n    this.quill.on(Quill.events.SCROLL_BLOT_MOUNT, (blot: Blot) => {\n      if (!(blot instanceof SyntaxCodeBlockContainer)) return;\n      const select = this.quill.root.ownerDocument.createElement('select');\n      // @ts-expect-error Fix me later\n      this.options.languages.forEach(({ key, label }) => {\n        const option = select.ownerDocument.createElement('option');\n        option.textContent = label;\n        option.setAttribute('value', key);\n        select.appendChild(option);\n      });\n      select.addEventListener('change', () => {\n        blot.format(SyntaxCodeBlock.blotName, select.value);\n        this.quill.root.focus(); // Prevent scrolling\n        this.highlight(blot, true);\n      });\n      if (blot.uiNode == null) {\n        blot.attachUI(select);\n        if (blot.children.head) {\n          select.value = SyntaxCodeBlock.formats(blot.children.head.domNode);\n        }\n      }\n    });\n  }\n\n  initTimer() {\n    let timer: ReturnType<typeof setTimeout> | null = null;\n    this.quill.on(Quill.events.SCROLL_OPTIMIZE, () => {\n      if (timer) {\n        clearTimeout(timer);\n      }\n      timer = setTimeout(() => {\n        this.highlight();\n        timer = null;\n      }, this.options.interval);\n    });\n  }\n\n  highlight(blot: SyntaxCodeBlockContainer | null = null, force = false) {\n    if (this.quill.selection.composing) return;\n    this.quill.update(Quill.sources.USER);\n    const range = this.quill.getSelection();\n    const blots =\n      blot == null\n        ? this.quill.scroll.descendants(SyntaxCodeBlockContainer)\n        : [blot];\n    blots.forEach((container) => {\n      container.highlight(this.highlightBlot, force);\n    });\n    this.quill.update(Quill.sources.SILENT);\n    if (range != null) {\n      this.quill.setSelection(range, Quill.sources.SILENT);\n    }\n  }\n\n  highlightBlot(text: string, language = 'plain') {\n    language = this.languages[language] ? language : 'plain';\n    if (language === 'plain') {\n      return escapeText(text)\n        .split('\\n')\n        .reduce((delta, line, i) => {\n          if (i !== 0) {\n            delta.insert('\\n', { [CodeBlock.blotName]: language });\n          }\n          return delta.insert(line);\n        }, new Delta());\n    }\n    const container = this.quill.root.ownerDocument.createElement('div');\n    container.classList.add(CodeBlock.className);\n    // @ts-expect-error\n    container.innerHTML = this.options.hljs.highlight(language, text).value;\n    return traverse(\n      this.quill.scroll,\n      container,\n      [\n        (node, delta) => {\n          // @ts-expect-error\n          const value = TokenAttributor.value(node);\n          if (value) {\n            return delta.compose(\n              new Delta().retain(delta.length(), {\n                [CodeToken.blotName]: value,\n              }),\n            );\n          }\n          return delta;\n        },\n      ],\n      [\n        (node, delta) => {\n          // @ts-expect-error\n          return node.data.split('\\n').reduce((memo, nodeText, i) => {\n            if (i !== 0) memo.insert('\\n', { [CodeBlock.blotName]: language });\n            return memo.insert(nodeText);\n          }, delta);\n        },\n      ],\n      new WeakMap(),\n    );\n  }\n}\nSyntax.DEFAULTS = {\n  hljs: (() => {\n    // @ts-expect-error\n    return window.hljs;\n  })(),\n  interval: 1000,\n  languages: [\n    { key: 'plain', label: 'Plain' },\n    { key: 'bash', label: 'Bash' },\n    { key: 'cpp', label: 'C++' },\n    { key: 'cs', label: 'C#' },\n    { key: 'css', label: 'CSS' },\n    { key: 'diff', label: 'Diff' },\n    { key: 'xml', label: 'HTML/XML' },\n    { key: 'java', label: 'Java' },\n    { key: 'javascript', label: 'Javascript' },\n    { key: 'markdown', label: 'Markdown' },\n    { key: 'php', label: 'PHP' },\n    { key: 'python', label: 'Python' },\n    { key: 'ruby', label: 'Ruby' },\n    { key: 'sql', label: 'SQL' },\n  ],\n};\n\nexport { SyntaxCodeBlock as CodeBlock, CodeToken, Syntax as default };\n"],"mappings":"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"}